<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RunWeather</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <!-- App Logic (ES Module) -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Cache Busting: increment v=ID on deploy -->
    <script type="module" src="src/main.js?v=1.0.7"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" data-action="tab" data-tab="calculator">Calculator</button>
        <button class="tab-btn" data-action="tab" data-tab="current">Conditions</button>
        <button class="tab-btn" data-action="tab" data-tab="forecast16">Forecast</button>
        <button class="tab-btn" data-action="tab" data-tab="climate">Climate</button>
    </div>

    <!-- TAB: CALCULATOR -->
    <div id="tab-calculator" class="tab-content active container" style="max-width: 650px;">
        <div class="header">
            <div class="header-left">
                <h1>Calculator</h1>
                <div class="subtitle" style="display:flex; align-items:center;">
                    NSA
                    <span
                        onclick="window.showInfoTooltip(event, 'Norwegian Singles Approach', 'Structured running method emphasizing three weekly sub-threshold sessions plus easy volume to maximize sustainable aerobic load and long-term progression. Developed by &lt;a href=&quot;https://mybook.to/XzwWbK3&quot; target=&quot;_blank&quot;&gt;James Copeland&lt;/a&gt;.')"
                        style="cursor:pointer; opacity:0.5; margin-left:4px; display:inline-flex; vertical-align:middle;">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                    </span>
                </div>
            </div>
            <button class="location-btn" data-action="location-modal" aria-label="Change Location"
                style="margin-left: auto; margin-right: 10px;">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                </svg>
                <span class="current-location-name">Florianópolis</span>
            </button>
            <button class="copy-btn" id="copy-btn" title="Copy results to clipboard" aria-label="Copy Results">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                Copy
            </button>
        </div>

        <div class="input-section" style="background:transparent; border:none; padding:0;">
            <!-- Time Trial Block -->
            <div class="modern-input-card">
                <div class="modern-label">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    Time Trial
                </div>
                <div class="input-row-grid">
                    <div class="floating-input-group">
                        <label for="dist-preset">Preset</label>
                        <select id="dist-preset" class="modern-input">
                            <option value="custom">Custom</option>
                            <option value="3000">3000m</option>
                            <option value="5000">5K</option>
                            <option value="10000">10K</option>
                            <option value="21097">Half Mar.</option>
                            <option value="42195">Marathon</option>
                        </select>
                    </div>
                    <div class="floating-input-group">
                        <label for="distance">Distance (m)</label>
                        <input type="number" id="distance" value="2955" placeholder="e.g. 5000" class="modern-input">
                    </div>
                    <div class="floating-input-group">
                        <label for="time">Time (MM:SS)</label>
                        <input type="text" id="time" value="11:16" placeholder="MM:SS" class="modern-input">
                    </div>
                    <div class="floating-input-group">
                        <label for="input-pace">Pace (/km)</label>
                        <input type="text" id="input-pace" placeholder="MM:SS" class="modern-input">
                    </div>
                </div>
            </div>

            <!-- Weather Block -->
            <div class="modern-input-card">
                <div class="modern-label">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"></path>
                    </svg>
                    Weather Conditions
                </div>
                <div class="input-row-grid cols-2">
                    <div class="floating-input-group">
                        <label for="temp">Temperature (°C)</label>
                        <input type="number" id="temp" placeholder="Temp" title="Temperature in Celsius"
                            class="modern-input">
                    </div>
                    <div class="floating-input-group">
                        <label for="dew">Dew Point (°C)</label>
                        <input type="number" id="dew" placeholder="Dew" title="Dew Point in Celsius"
                            class="modern-input">
                    </div>
                </div>
                <div id="weather-impact"
                    style="font-size: 0.8rem; color: var(--lactate-color); margin-top: 12px; font-weight:500; min-height:1em;">
                </div>
            </div>
        </div>

        <div class="vdot-box" id="vdot-card" style="flex-direction:column; align-items:stretch; cursor:pointer;"
            data-action="vdot-details">
            <div class="vdot-header flex-between">
                <div class="vdot-info">
                    <div class="vdot-label">Estimated VDOT <span
                            style="font-size:0.7em; opacity:0.7; font-weight:400;">(Click to Expand)</span></div>
                    <div class="vdot-sub">Based on 5k: <span id="pred-5k" style="color:#e6edf3;">--:--</span></div>
                    <div class="vdot-sub" style="margin-top:2px;">Threshold: <span id="vdot-threshold"
                            style="color:#e6edf3; font-weight:700;">--:--/km</span></div>
                </div>
                <div class="vdot-right" style="text-align:right;">
                    <div class="vdot-val" id="vdot-val">--</div>
                </div>
            </div>
            <div id="vdot-details"
                style="display:none; margin-top:16px; border-top:1px solid rgba(255,255,255,0.1); padding-top:12px;">
                <!-- Detailed Rows will be injected here -->
            </div>
        </div>

        <div class="card">
            <div class="card-title">
                Subthreshold
            </div>

            <div class="data-row">
                <div class="data-label-group">
                    <span class="data-label">3 min rep <span class="tag tag-15kp">15KP</span></span>
                </div>
                <div class="data-value-group">
                    <div class="data-value" id="pace-3min">--:--/km</div>
                    <div class="data-sub" id="dist-3min">-- m</div>
                </div>
            </div>

            <div class="data-row">
                <div class="data-label-group">
                    <span class="data-label">6 min rep <span class="tag tag-hmp">HMP</span></span>
                </div>
                <div class="data-value-group">
                    <div class="data-value" id="pace-6min">--:--/km</div>
                    <div class="data-sub" id="dist-6min">-- m</div>
                </div>
            </div>

            <div class="data-row">
                <div class="data-label-group">
                    <span class="data-label">10 min rep <span class="tag tag-30kp">30KP</span></span>

                </div>
                <div class="data-value-group">
                    <div class="data-value" id="pace-10min">--:--/km</div>
                    <div class="data-sub" id="dist-10min">-- m</div>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 16px;">
            <div class="card-title">
                Easy Run
            </div>
            <div class="data-row">
                <div class="data-label-group">
                    <span class="data-label">Easy Pace <span class="tag tag-ez">EZ</span></span>
                </div>
                <div class="data-value-group">
                    <div class="data-value" id="pace-easy">--:--/km</div>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB: CURRENT -->
    <div id="tab-current" class="tab-content container" style="max-width: 650px;">
        <div class="header">
            <div class="header-left">
                <h1>Conditions</h1>
                <div class="subtitle" style="display:flex; align-items:center;">
                    Real-time Weather
                    <span onclick="window.showInfoTooltip(event, '', 'Weather data provided by Open-Meteo.')"
                        style="cursor:pointer; opacity:0.5; margin-left:4px; display:inline-flex; vertical-align:middle;">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                    </span>
                </div>
            </div>
            <button class="location-btn" data-action="location-modal" aria-label="Change Location"
                style="margin-left: auto; margin-right: 10px;">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                </svg>
                <span class="current-location-name">Florianópolis</span>
            </button>
            <button class="copy-btn" id="btn-copy-cond" onclick="window.copyConditions()"
                title="Copy conditions to clipboard" aria-label="Copy Conditions">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                Copy
            </button>
        </div>
        <div id="current-content" class="current-grid">
            <div style="text-align:center; padding:40px; color:var(--text-secondary);">
                <svg class="animate-spin" style="width:24px;height:24px;margin:auto;" xmlns="http://www.w3.org/2000/svg"
                    fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <div style="margin-top:12px; font-size:0.9em;">Loading Weather...</div>
            </div>
        </div>
    </div>
    <div id="loading-current" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    </div>



    <!-- TAB: FORECAST 16 DAYS -->
    <div id="tab-forecast16" class="tab-content container" style="max-width: 650px;">
        <div class="header">
            <div class="header-left">
                <h1>Forecast</h1>
                <div class="subtitle">14-Day Heat Impact</div>
            </div>
            <button class="location-btn" data-action="location-modal" aria-label="Change Location">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                </svg>
                <span class="current-location-name">Florianópolis</span>
            </button>
        </div>

        <!-- Best Run Time Banner (Minimal) -->
        <div id="best-run-banner" class="insight-banner" style="display:none;">
            <div class="insight-left">
                <span style="margin-right:8px;">Best Window</span>
                <div class="insight-selector">
                    <span class="insight-btn active" data-action="insight-range" data-range="24h">24h</span>
                    <span class="insight-btn" data-action="insight-range" data-range="7d">7d</span>
                    <span class="insight-btn" data-action="insight-range" data-range="14d">14d</span>
                </div>
            </div>
            <div style="text-align:right;">
                <span class="insight-val" id="best-run-val">--:--</span>
                <span id="best-run-impact" class="insight-impact">--%</span>
            </div>
        </div>

        <!-- Weekly Heatmap -->
        <div
            style="background:var(--card-bg); border-radius:12px; padding:15px; margin-bottom:20px; border:1px solid var(--border-color);">
            <h3 class="h3-title">
                Forecast Heatmap</h3>
            <div style="overflow-x:auto;">
                <div id="forecast-grid-container-16" class="forecast-grid">
                    <!-- JS Injected -->
                </div>
            </div>
            <!-- Legend -->
            <div class="legend-container" id="legend-container-16"
                style="display:flex; justify-content:center; gap:8px; margin-top:10px; font-size:0.75rem; color:var(--text-secondary); align-items:center; flex-wrap:wrap;">
                <!-- JS Injected -->
            </div>
        </div>

        <!-- Trend Chart -->
        <div
            style="background:var(--card-bg); border-radius:12px; padding:15px; margin-bottom:20px; border:1px solid var(--border-color);">
            <h3 class="h3-title">
                Temperature & Dew Point</h3>
            <div id="forecast-chart-container-16" class="chart-box">
                <!-- JS Injected SVG -->
                <div style="text-align:center; color:var(--text-secondary); font-size:0.8rem; padding-top:60px;">Loading
                    Chart...</div>
            </div>
            <div style="display:flex; justify-content:center; gap:16px; margin-top:10px; font-size:0.75rem;">
                <div style="color:#f87171; display:flex; align-items:center; gap:4px;"><span
                        style="width:8px; height:8px; border-radius:50%; background:#f87171;"></span> Temp</div>
                <div style="color:#60a5fa; display:flex; align-items:center; gap:4px;"><span
                        style="width:8px; height:8px; border-radius:50%; background:#60a5fa;"></span> Dew Point</div>
            </div>
        </div>

        <!-- Pace Selector (Shared State) -->
        <div style="margin-bottom:15px; display:flex; justify-content:flex-end; align-items:center;">
            <span style="font-size:0.8rem; color:var(--text-secondary); margin-right:8px;">Adjust Paces For:</span>
            <div id="pace-tag-container-16" style="display:flex; gap:8px;">
                <button class="tag-btn tag-15kp" data-action="pace-mode" data-mode="15KP">15KP (3min)</button>
                <button class="tag-btn tag-hmp active" data-action="pace-mode" data-mode="HMP">HMP (6min)</button>
                <button class="tag-btn tag-30kp" data-action="pace-mode" data-mode="30KP">30KP (10min)</button>
                <button class="tag-btn tag-ez" data-action="pace-mode" data-mode="EZ">Easy Pace</button>
            </div>
        </div>

        <div class="table-wrapper">
            <table class="forecast-table">
                <thead>
                    <tr>
                        <th data-action="sort-forecast" data-col="time" style="cursor:pointer">Time</th>
                        <th data-action="sort-forecast" data-col="temp" style="text-align:center; cursor:pointer">Temp
                        </th>
                        <th data-action="sort-forecast" data-col="dew" style="text-align:center; cursor:pointer">Dew
                        </th>
                        <th data-action="sort-forecast" data-col="rain"
                            style="min-width:60px; text-align:center; cursor:pointer">Rain/Prob</th>

                        <th data-action="sort-forecast" data-col="wind"
                            style="min-width:70px; text-align:center; cursor:pointer">Wind</th>
                        <th data-action="sort-forecast" data-col="impact" style="text-align:center; cursor:pointer">
                            Impact
                        </th>
                        <th data-action="sort-forecast" data-col="impact" style="text-align:right; cursor:pointer">Adj
                            Pace
                        </th>
                    </tr>
                </thead>
                <tbody id="forecast-body-16">
                    <tr>
                        <td colspan="5" style="text-align:center; padding:20px;">Loading forecast...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div id="loading-forecast" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    </div>

    <!-- Climate Tab -->
    <div id="tab-climate" class="tab-content container" style="max-width: 650px;">
        <div class="header">
            <div class="header-left">
                <h1>Climate Analysis</h1>
                <div class="subtitle" style="display:flex; align-items:center;">
                    Historical Trends
                    <span
                        onclick="window.showInfoTooltip(event, '', 'Analysis based on the last 6 years of historical weather data from Open-Meteo.')"
                        style="cursor:pointer; opacity:0.5; margin-left:4px; display:inline-flex; vertical-align:middle;">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                    </span>
                </div>
            </div>
            <button class="location-btn" data-action="location-modal" aria-label="Change Location">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                </svg>
                <span class="current-location-name">Florianópolis</span>
            </button>
        </div>

        <div
            style="background:var(--card-bg); border-radius:12px; padding:15px; margin-bottom:20px; border:1px solid var(--border-color); overflow-x:auto;">
            <h3 style="margin-top:0; margin-bottom:15px; font-size:1rem; font-weight:600; color:var(--text-primary);">
                Seasonal Heat Impact
            </h3>

            <div>
                <!-- Static X-Axis Labels removed; now rendered by SVG -->
                <!-- <div
                    style="display:flex; justify-content:space-between; padding-left:40px; margin-bottom:5px; color:var(--text-secondary); font-size:0.75rem;">
                    <span>Jan</span><span>Feb</span><span>Mar</span><span>Apr</span><span>May</span><span>Jun</span>
                    <span>Jul</span><span>Aug</span><span>Sep</span><span>Oct</span><span>Nov</span><span>Dec</span>
                </div> -->

                <div id="climate-heatmap-container"
                    style="display:grid; gap:1px; grid-template-columns: 40px repeat(53, 1fr);">
                    <!-- JS Injected -->
                </div>

                <div id="climate-legend-container"
                    style="display:flex; justify-content:center; gap:8px; margin-top:10px; font-size:0.75rem; color:var(--text-secondary); align-items:center; flex-wrap:wrap;">
                    <!-- JS Injected -->
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div style="background:var(--card-bg); border-radius:12px; padding:15px; border:1px solid var(--border-color);">
            <div class="flex-between" style="margin-bottom:15px;">
                <h3 class="h3-title" style="margin:0;">Historical Data Detail</h3>
                <div class="start-center gap-2">
                    <span id="climate-filter-label"
                        style="display:none; font-size:0.65rem; background:var(--accent-color); color:white; padding:1px 4px; border-radius:2px;"></span>
                    <button id="climate-clear-filter" data-action="filter-climate"
                        style="display:none; background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:0.75rem; text-decoration:underline;">Clear</button>
                </div>
            </div>

            <div class="table-wrapper">
                <table class="forecast-table">
                    <thead style="position:sticky; top:0; background:var(--card-bg); z-index:10;">
                        <tr>
                            <th style="cursor:pointer; width:35%;" data-action="sort-climate" data-col="date">Time <span
                                    id="sort-icon-climate-date"></span></th>
                            <th style="cursor:pointer; text-align:center;" data-action="sort-climate" data-col="temp">
                                Temp <span id="sort-icon-climate-temp"></span></th>
                            <th style="cursor:pointer; text-align:center;" data-action="sort-climate" data-col="dew">Dew
                                <span id="sort-icon-climate-dew"></span>
                            </th>
                            <th style="cursor:pointer; text-align:center;" data-action="sort-climate" data-col="precip">
                                Rain <span id="sort-icon-climate-precip"></span></th>
                            <th style="cursor:pointer; text-align:center;" data-action="sort-climate" data-col="wind">
                                Wind <span id="sort-icon-climate-wind"></span></th>
                            <th style="cursor:pointer; text-align:center;" data-action="sort-climate" data-col="impact">
                                Impact <span id="sort-icon-climate-impact">▼</span></th>
                        </tr>
                    </thead>
                    <tbody id="climateTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="loading-climate" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    </div>

    <div id="forecast-tooltip" class="forecast-tooltip"></div>
    <!-- Location Modal -->
    <div id="loc-modal" class="modal-backdrop">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:600; color:white;">Select Location</span>
                <span id="close-modal" class="clickable" data-action="location-close"
                    style="font-size:1.5rem; line-height:1; color:var(--text-secondary);">&times;</span>
            </div>

            <button data-action="gps" class="modern-button" id="gps-btn"
                style="width:100%; display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:10px;">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M12 22s-8-4-8-10V5l8-3 8 3v7c0 6-8 10-8 10z"></path>
                </svg>
                Use My Location
            </button>

            <div style="text-align:center; color:var(--text-secondary); font-size:0.8rem; margin:5px 0;">OR</div>

            <div class="search-box">
                <svg class="search-icon" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"
                    viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <input type="text" id="loc-search" class="search-input" placeholder="Search city..." autocomplete="off">
            </div>

            <div id="loc-results" class="loc-results"></div>
        </div>
    </div>

    <!-- PWA Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(() => console.log('SW Ready'))
                .catch(err => console.error('SW Fail', err));
        }
    </script>
</body>

</html>